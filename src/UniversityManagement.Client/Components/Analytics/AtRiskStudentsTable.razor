@* At-Risk Students Table Component for Dean Dashboard *@
@using UniversityManagement.Shared.DTOs.Analytics

<MudPaper Elevation="2" Class="pa-4">
    <MudStack Spacing="3">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.h6">At-Risk Students</MudText>
            <MudChip Color="Color.Warning" Size="Size.Small">@(Students?.Count ?? 0) students</MudChip>
        </MudStack>
        
        @if (IsLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        }
        else if (Students == null || !Students.Any())
        {
            <MudAlert Severity="Severity.Success">No at-risk students at this time!</MudAlert>
        }
        else
        {
            <MudTable Items="@Students" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true" Filter="new Func<AtRiskStudentDto,bool>(FilterFunc)">
                <ToolBarContent>
                    <MudSpacer />
                    <MudTextField @bind-Value="searchString" Placeholder="Search students..." 
                                  Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" 
                                  IconSize="Size.Medium" Class="mt-0" Immediate="true"></MudTextField>
                </ToolBarContent>
                <HeaderContent>
                    <MudTh>Student</MudTh>
                    <MudTh>Program</MudTh>
                    <MudTh>Year</MudTh>
                    <MudTh>GPA</MudTh>
                    <MudTh>Attendance</MudTh>
                    <MudTh>Failed Courses</MudTh>
                    <MudTh>Risk Level</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Student">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.body2"><strong>@context.StudentName</strong></MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@context.EnrollmentNumber</MudText>
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="Program">@context.ProgramName</MudTd>
                    <MudTd DataLabel="Year">Year @context.YearOfStudy</MudTd>
                    <MudTd DataLabel="GPA">
                        <MudChip Size="Size.Small" Color="@GetGpaColor(context.CurrentGpa)">
                            @context.CurrentGpa.ToString("F2")
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Attendance">@context.AttendanceRate.ToString("F0")%</MudTd>
                    <MudTd DataLabel="Failed Courses">
                        @if (context.FailedCourses > 0)
                        {
                            <MudChip Size="Size.Small" Color="Color.Error">@context.FailedCourses</MudChip>
                        }
                        else
                        {
                            <MudText>-</MudText>
                        }
                    </MudTd>
                    <MudTd DataLabel="Risk Level">
                        <MudChip Size="Size.Small" Color="@GetRiskColor(context.RiskLevel)">
                            @context.RiskLevel.Replace("_", " ").ToUpper()
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Actions">
                        <MudIconButton Icon="@Icons.Material.Filled.Email" Color="Color.Primary" Size="Size.Small" 
                                       Title="Send Email" OnClick="@(() => OnContactStudent(context))" />
                        <MudIconButton Icon="@Icons.Material.Filled.Phone" Color="Color.Info" Size="Size.Small" 
                                       Title="Call Student" OnClick="@(() => OnContactStudent(context))" />
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudStack>
</MudPaper>

@code {
    [Parameter]
    public List<AtRiskStudentDto>? Students { get; set; }
    
    [Parameter]
    public bool IsLoading { get; set; }
    
    [Parameter]
    public EventCallback<AtRiskStudentDto> OnContactStudent { get; set; }
    
    private string searchString = "";
    
    private bool FilterFunc(AtRiskStudentDto student)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (student.StudentName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (student.EnrollmentNumber.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (student.ProgramName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        return false;
    }
    
    private Color GetGpaColor(decimal gpa) => gpa switch
    {
        >= 7.0m => Color.Success,
        >= 6.0m => Color.Warning,
        _ => Color.Error
    };
    
    private Color GetRiskColor(string riskLevel) => riskLevel.ToLower() switch
    {
        "high" => Color.Error,
        "medium" => Color.Warning,
        _ => Color.Info
    };
}
